/** @file mode_switch_asm.S
 *  @brief Fault handler wrappers and mode switching code
 *
 *  @author Jonathan Ong (jonathao)
 *  @author Evan Palmer (esp)
 *  @bug No known bugs.
 */

#include <idt.h>
#include <seg.h>

/** @brief Save user mode state and switch to kernel mode */
.macro SAVE_STATE
    pusha
    pushl %gs
    pushl %fs
    pushl %es
    pushl %ds
    mov $SEGSEL_KERNEL_DS, %eax
    mov %ax, %ds
    mov %ax, %es
    mov %ax, %fs
    mov %ax, %gs
.endm

/**  @brief Restores state to user mode */
.macro RESTORE_STATE
    pushl %esp                          # provide a stack address to get tcb
    call set_regs                       # set esp0
    add $4, %esp                        # clean up function call stack
    add $8, %esp                        # clean up ureg arguments
    popl %ds
    popl %es
    popl %fs
    popl %gs
    popa
    add $4, %esp
    iret
.endm

.macro INTERRUPT_ASM_WRAPPER NAME
    .global \NAME\()_asm
    \NAME\()_asm:
        pushl $0                        # set ureg.error_code = 0
        SAVE_STATE
        pushl $0                        # set ureg.cr2 = 0
        pushl $0                        # set ureg.cause = 0
        call \NAME\()
        RESTORE_STATE
.endm

.macro EXCEPTION_ASM_WRAPPER_ERROR INT
    .global interrupt\INT\()_asm
    interrupt\INT\()_asm:
        SAVE_STATE
        pushl $0
        pushl $\INT\()
        call fault_handler
        RESTORE_STATE
.endm

.macro EXCEPTION_ASM_WRAPPER_DEVICE INT
    .global interrupt\INT\()_asm
    interrupt\INT\()_asm:
        pushl $0
        SAVE_STATE
        pushl $0
        pushl $\INT\()
        call device_handler
        RESTORE_STATE
.endm

.macro EXCEPTION_ASM_WRAPPER INT
    .global interrupt\INT\()_asm
    interrupt\INT\()_asm:
        pushl $0
        SAVE_STATE
        pushl $0
        pushl $\INT\()
        call fault_handler
        RESTORE_STATE
.endm

/* Assembly function for entering user mode for the first time */
.global go_to_user_mode
go_to_user_mode:
    movl 4(%esp), %esp      # switch stack pointers
    RESTORE_STATE           # perform the mode switch

/* Assembly wrappers for device interrupts */
INTERRUPT_ASM_WRAPPER timer_interrupt
INTERRUPT_ASM_WRAPPER keyboard_interrupt

/* Assembly wrappers for system call interrupts */
INTERRUPT_ASM_WRAPPER fork_syscall
INTERRUPT_ASM_WRAPPER exec_syscall
INTERRUPT_ASM_WRAPPER set_status_syscall
INTERRUPT_ASM_WRAPPER vanish_syscall
INTERRUPT_ASM_WRAPPER task_vanish_syscall
INTERRUPT_ASM_WRAPPER wait_syscall

INTERRUPT_ASM_WRAPPER gettid_syscall
INTERRUPT_ASM_WRAPPER yield_syscall
INTERRUPT_ASM_WRAPPER deschedule_syscall
INTERRUPT_ASM_WRAPPER make_runnable_syscall
INTERRUPT_ASM_WRAPPER get_ticks_syscall
INTERRUPT_ASM_WRAPPER sleep_syscall
INTERRUPT_ASM_WRAPPER thread_fork_syscall

INTERRUPT_ASM_WRAPPER new_pages_syscall
INTERRUPT_ASM_WRAPPER remove_pages_syscall

INTERRUPT_ASM_WRAPPER getchar_syscall
INTERRUPT_ASM_WRAPPER readline_syscall
INTERRUPT_ASM_WRAPPER print_syscall
INTERRUPT_ASM_WRAPPER set_term_color_syscall
INTERRUPT_ASM_WRAPPER set_cursor_pos_syscall
INTERRUPT_ASM_WRAPPER get_cursor_pos_syscall

INTERRUPT_ASM_WRAPPER halt_syscall
INTERRUPT_ASM_WRAPPER readfile_syscall
INTERRUPT_ASM_WRAPPER misbehave_syscall
INTERRUPT_ASM_WRAPPER swexn_syscall

INTERRUPT_ASM_WRAPPER udriv_register_syscall
INTERRUPT_ASM_WRAPPER udriv_deregister_syscall
INTERRUPT_ASM_WRAPPER udriv_send_syscall
INTERRUPT_ASM_WRAPPER udriv_wait_syscall
INTERRUPT_ASM_WRAPPER udriv_inb_syscall
INTERRUPT_ASM_WRAPPER udriv_outb_syscall
INTERRUPT_ASM_WRAPPER udriv_mmap_syscall

/* Assembly wrappers for various system interrutps */
EXCEPTION_ASM_WRAPPER IDT_DE
EXCEPTION_ASM_WRAPPER IDT_DB
EXCEPTION_ASM_WRAPPER IDT_NMI
EXCEPTION_ASM_WRAPPER IDT_BP
EXCEPTION_ASM_WRAPPER IDT_OF
EXCEPTION_ASM_WRAPPER IDT_BR
EXCEPTION_ASM_WRAPPER IDT_UD
EXCEPTION_ASM_WRAPPER IDT_NM
EXCEPTION_ASM_WRAPPER_ERROR IDT_DF
EXCEPTION_ASM_WRAPPER IDT_CSO
EXCEPTION_ASM_WRAPPER_ERROR IDT_TS
EXCEPTION_ASM_WRAPPER_ERROR IDT_NP
EXCEPTION_ASM_WRAPPER_ERROR IDT_SS
EXCEPTION_ASM_WRAPPER_ERROR IDT_GP
EXCEPTION_ASM_WRAPPER_ERROR IDT_PF
EXCEPTION_ASM_WRAPPER IDT_MF
EXCEPTION_ASM_WRAPPER_ERROR IDT_AC
EXCEPTION_ASM_WRAPPER IDT_MC
EXCEPTION_ASM_WRAPPER IDT_XF

/* Assembly wrappers for every user defined interrupt */
EXCEPTION_ASM_WRAPPER_DEVICE 32
EXCEPTION_ASM_WRAPPER_DEVICE 33
EXCEPTION_ASM_WRAPPER_DEVICE 34
EXCEPTION_ASM_WRAPPER_DEVICE 35
EXCEPTION_ASM_WRAPPER_DEVICE 36
EXCEPTION_ASM_WRAPPER_DEVICE 37
EXCEPTION_ASM_WRAPPER_DEVICE 38
EXCEPTION_ASM_WRAPPER_DEVICE 39
EXCEPTION_ASM_WRAPPER_DEVICE 40
EXCEPTION_ASM_WRAPPER_DEVICE 41
EXCEPTION_ASM_WRAPPER_DEVICE 42
EXCEPTION_ASM_WRAPPER_DEVICE 43
EXCEPTION_ASM_WRAPPER_DEVICE 44
EXCEPTION_ASM_WRAPPER_DEVICE 45
EXCEPTION_ASM_WRAPPER_DEVICE 46
EXCEPTION_ASM_WRAPPER_DEVICE 47
EXCEPTION_ASM_WRAPPER_DEVICE 48
EXCEPTION_ASM_WRAPPER_DEVICE 49
EXCEPTION_ASM_WRAPPER_DEVICE 50
EXCEPTION_ASM_WRAPPER_DEVICE 51
EXCEPTION_ASM_WRAPPER_DEVICE 52
EXCEPTION_ASM_WRAPPER_DEVICE 53
EXCEPTION_ASM_WRAPPER_DEVICE 54
EXCEPTION_ASM_WRAPPER_DEVICE 55
EXCEPTION_ASM_WRAPPER_DEVICE 56
EXCEPTION_ASM_WRAPPER_DEVICE 57
EXCEPTION_ASM_WRAPPER_DEVICE 58
EXCEPTION_ASM_WRAPPER_DEVICE 59
EXCEPTION_ASM_WRAPPER_DEVICE 60
EXCEPTION_ASM_WRAPPER_DEVICE 61
EXCEPTION_ASM_WRAPPER_DEVICE 62
EXCEPTION_ASM_WRAPPER_DEVICE 63
EXCEPTION_ASM_WRAPPER_DEVICE 64
EXCEPTION_ASM_WRAPPER_DEVICE 65
EXCEPTION_ASM_WRAPPER_DEVICE 66
EXCEPTION_ASM_WRAPPER_DEVICE 67
EXCEPTION_ASM_WRAPPER_DEVICE 68
EXCEPTION_ASM_WRAPPER_DEVICE 69
EXCEPTION_ASM_WRAPPER_DEVICE 70
EXCEPTION_ASM_WRAPPER_DEVICE 71
EXCEPTION_ASM_WRAPPER_DEVICE 72
EXCEPTION_ASM_WRAPPER_DEVICE 73
EXCEPTION_ASM_WRAPPER_DEVICE 74
EXCEPTION_ASM_WRAPPER_DEVICE 75
EXCEPTION_ASM_WRAPPER_DEVICE 76
EXCEPTION_ASM_WRAPPER_DEVICE 77
EXCEPTION_ASM_WRAPPER_DEVICE 78
EXCEPTION_ASM_WRAPPER_DEVICE 79
EXCEPTION_ASM_WRAPPER_DEVICE 80
EXCEPTION_ASM_WRAPPER_DEVICE 81
EXCEPTION_ASM_WRAPPER_DEVICE 82
EXCEPTION_ASM_WRAPPER_DEVICE 83
EXCEPTION_ASM_WRAPPER_DEVICE 84
EXCEPTION_ASM_WRAPPER_DEVICE 85
EXCEPTION_ASM_WRAPPER_DEVICE 86
EXCEPTION_ASM_WRAPPER_DEVICE 87
EXCEPTION_ASM_WRAPPER_DEVICE 88
EXCEPTION_ASM_WRAPPER_DEVICE 89
EXCEPTION_ASM_WRAPPER_DEVICE 90
EXCEPTION_ASM_WRAPPER_DEVICE 91
EXCEPTION_ASM_WRAPPER_DEVICE 92
EXCEPTION_ASM_WRAPPER_DEVICE 93
EXCEPTION_ASM_WRAPPER_DEVICE 94
EXCEPTION_ASM_WRAPPER_DEVICE 95
EXCEPTION_ASM_WRAPPER_DEVICE 96
EXCEPTION_ASM_WRAPPER_DEVICE 97
EXCEPTION_ASM_WRAPPER_DEVICE 98
EXCEPTION_ASM_WRAPPER_DEVICE 99
EXCEPTION_ASM_WRAPPER_DEVICE 100
EXCEPTION_ASM_WRAPPER_DEVICE 101
EXCEPTION_ASM_WRAPPER_DEVICE 102
EXCEPTION_ASM_WRAPPER_DEVICE 103
EXCEPTION_ASM_WRAPPER_DEVICE 104
EXCEPTION_ASM_WRAPPER_DEVICE 105
EXCEPTION_ASM_WRAPPER_DEVICE 106
EXCEPTION_ASM_WRAPPER_DEVICE 107
EXCEPTION_ASM_WRAPPER_DEVICE 108
EXCEPTION_ASM_WRAPPER_DEVICE 109
EXCEPTION_ASM_WRAPPER_DEVICE 110
EXCEPTION_ASM_WRAPPER_DEVICE 111
EXCEPTION_ASM_WRAPPER_DEVICE 112
EXCEPTION_ASM_WRAPPER_DEVICE 113
EXCEPTION_ASM_WRAPPER_DEVICE 114
EXCEPTION_ASM_WRAPPER_DEVICE 115
EXCEPTION_ASM_WRAPPER_DEVICE 116
EXCEPTION_ASM_WRAPPER_DEVICE 117
EXCEPTION_ASM_WRAPPER_DEVICE 118
EXCEPTION_ASM_WRAPPER_DEVICE 119
EXCEPTION_ASM_WRAPPER_DEVICE 120
EXCEPTION_ASM_WRAPPER_DEVICE 121
EXCEPTION_ASM_WRAPPER_DEVICE 122
EXCEPTION_ASM_WRAPPER_DEVICE 123
EXCEPTION_ASM_WRAPPER_DEVICE 124
EXCEPTION_ASM_WRAPPER_DEVICE 125
EXCEPTION_ASM_WRAPPER_DEVICE 126
EXCEPTION_ASM_WRAPPER_DEVICE 127
EXCEPTION_ASM_WRAPPER_DEVICE 128
EXCEPTION_ASM_WRAPPER_DEVICE 129
EXCEPTION_ASM_WRAPPER_DEVICE 130
EXCEPTION_ASM_WRAPPER_DEVICE 131
EXCEPTION_ASM_WRAPPER_DEVICE 132
EXCEPTION_ASM_WRAPPER_DEVICE 133
EXCEPTION_ASM_WRAPPER_DEVICE 134
EXCEPTION_ASM_WRAPPER_DEVICE 135
EXCEPTION_ASM_WRAPPER_DEVICE 136
EXCEPTION_ASM_WRAPPER_DEVICE 137
EXCEPTION_ASM_WRAPPER_DEVICE 138
EXCEPTION_ASM_WRAPPER_DEVICE 139
EXCEPTION_ASM_WRAPPER_DEVICE 140
EXCEPTION_ASM_WRAPPER_DEVICE 141
EXCEPTION_ASM_WRAPPER_DEVICE 142
EXCEPTION_ASM_WRAPPER_DEVICE 143
EXCEPTION_ASM_WRAPPER_DEVICE 144
EXCEPTION_ASM_WRAPPER_DEVICE 145
EXCEPTION_ASM_WRAPPER_DEVICE 146
EXCEPTION_ASM_WRAPPER_DEVICE 147
EXCEPTION_ASM_WRAPPER_DEVICE 148
EXCEPTION_ASM_WRAPPER_DEVICE 149
EXCEPTION_ASM_WRAPPER_DEVICE 150
EXCEPTION_ASM_WRAPPER_DEVICE 151
EXCEPTION_ASM_WRAPPER_DEVICE 152
EXCEPTION_ASM_WRAPPER_DEVICE 153
EXCEPTION_ASM_WRAPPER_DEVICE 154
EXCEPTION_ASM_WRAPPER_DEVICE 155
EXCEPTION_ASM_WRAPPER_DEVICE 156
EXCEPTION_ASM_WRAPPER_DEVICE 157
EXCEPTION_ASM_WRAPPER_DEVICE 158
EXCEPTION_ASM_WRAPPER_DEVICE 159
EXCEPTION_ASM_WRAPPER_DEVICE 160
EXCEPTION_ASM_WRAPPER_DEVICE 161
EXCEPTION_ASM_WRAPPER_DEVICE 162
EXCEPTION_ASM_WRAPPER_DEVICE 163
EXCEPTION_ASM_WRAPPER_DEVICE 164
EXCEPTION_ASM_WRAPPER_DEVICE 165
EXCEPTION_ASM_WRAPPER_DEVICE 166
EXCEPTION_ASM_WRAPPER_DEVICE 167
EXCEPTION_ASM_WRAPPER_DEVICE 168
EXCEPTION_ASM_WRAPPER_DEVICE 169
EXCEPTION_ASM_WRAPPER_DEVICE 170
EXCEPTION_ASM_WRAPPER_DEVICE 171
EXCEPTION_ASM_WRAPPER_DEVICE 172
EXCEPTION_ASM_WRAPPER_DEVICE 173
EXCEPTION_ASM_WRAPPER_DEVICE 174
EXCEPTION_ASM_WRAPPER_DEVICE 175
EXCEPTION_ASM_WRAPPER_DEVICE 176
EXCEPTION_ASM_WRAPPER_DEVICE 177
EXCEPTION_ASM_WRAPPER_DEVICE 178
EXCEPTION_ASM_WRAPPER_DEVICE 179
EXCEPTION_ASM_WRAPPER_DEVICE 180
EXCEPTION_ASM_WRAPPER_DEVICE 181
EXCEPTION_ASM_WRAPPER_DEVICE 182
EXCEPTION_ASM_WRAPPER_DEVICE 183
EXCEPTION_ASM_WRAPPER_DEVICE 184
EXCEPTION_ASM_WRAPPER_DEVICE 185
EXCEPTION_ASM_WRAPPER_DEVICE 186
EXCEPTION_ASM_WRAPPER_DEVICE 187
EXCEPTION_ASM_WRAPPER_DEVICE 188
EXCEPTION_ASM_WRAPPER_DEVICE 189
EXCEPTION_ASM_WRAPPER_DEVICE 190
EXCEPTION_ASM_WRAPPER_DEVICE 191
EXCEPTION_ASM_WRAPPER_DEVICE 192
EXCEPTION_ASM_WRAPPER_DEVICE 193
EXCEPTION_ASM_WRAPPER_DEVICE 194
EXCEPTION_ASM_WRAPPER_DEVICE 195
EXCEPTION_ASM_WRAPPER_DEVICE 196
EXCEPTION_ASM_WRAPPER_DEVICE 197
EXCEPTION_ASM_WRAPPER_DEVICE 198
EXCEPTION_ASM_WRAPPER_DEVICE 199
EXCEPTION_ASM_WRAPPER_DEVICE 200
EXCEPTION_ASM_WRAPPER_DEVICE 201
EXCEPTION_ASM_WRAPPER_DEVICE 202
EXCEPTION_ASM_WRAPPER_DEVICE 203
EXCEPTION_ASM_WRAPPER_DEVICE 204
EXCEPTION_ASM_WRAPPER_DEVICE 205
EXCEPTION_ASM_WRAPPER_DEVICE 206
EXCEPTION_ASM_WRAPPER_DEVICE 207
EXCEPTION_ASM_WRAPPER_DEVICE 208
EXCEPTION_ASM_WRAPPER_DEVICE 209
EXCEPTION_ASM_WRAPPER_DEVICE 210
EXCEPTION_ASM_WRAPPER_DEVICE 211
EXCEPTION_ASM_WRAPPER_DEVICE 212
EXCEPTION_ASM_WRAPPER_DEVICE 213
EXCEPTION_ASM_WRAPPER_DEVICE 214
EXCEPTION_ASM_WRAPPER_DEVICE 215
EXCEPTION_ASM_WRAPPER_DEVICE 216
EXCEPTION_ASM_WRAPPER_DEVICE 217
EXCEPTION_ASM_WRAPPER_DEVICE 218
EXCEPTION_ASM_WRAPPER_DEVICE 219
EXCEPTION_ASM_WRAPPER_DEVICE 220
EXCEPTION_ASM_WRAPPER_DEVICE 221
EXCEPTION_ASM_WRAPPER_DEVICE 222
EXCEPTION_ASM_WRAPPER_DEVICE 223
EXCEPTION_ASM_WRAPPER_DEVICE 224
EXCEPTION_ASM_WRAPPER_DEVICE 225
EXCEPTION_ASM_WRAPPER_DEVICE 226
EXCEPTION_ASM_WRAPPER_DEVICE 227
EXCEPTION_ASM_WRAPPER_DEVICE 228
EXCEPTION_ASM_WRAPPER_DEVICE 229
EXCEPTION_ASM_WRAPPER_DEVICE 230
EXCEPTION_ASM_WRAPPER_DEVICE 231
EXCEPTION_ASM_WRAPPER_DEVICE 232
EXCEPTION_ASM_WRAPPER_DEVICE 233
EXCEPTION_ASM_WRAPPER_DEVICE 234
EXCEPTION_ASM_WRAPPER_DEVICE 235
EXCEPTION_ASM_WRAPPER_DEVICE 236
EXCEPTION_ASM_WRAPPER_DEVICE 237
EXCEPTION_ASM_WRAPPER_DEVICE 238
EXCEPTION_ASM_WRAPPER_DEVICE 239
EXCEPTION_ASM_WRAPPER_DEVICE 240
EXCEPTION_ASM_WRAPPER_DEVICE 241
EXCEPTION_ASM_WRAPPER_DEVICE 242
EXCEPTION_ASM_WRAPPER_DEVICE 243
EXCEPTION_ASM_WRAPPER_DEVICE 244
EXCEPTION_ASM_WRAPPER_DEVICE 245
EXCEPTION_ASM_WRAPPER_DEVICE 246
EXCEPTION_ASM_WRAPPER_DEVICE 247
EXCEPTION_ASM_WRAPPER_DEVICE 248
EXCEPTION_ASM_WRAPPER_DEVICE 249
EXCEPTION_ASM_WRAPPER_DEVICE 250
EXCEPTION_ASM_WRAPPER_DEVICE 251
EXCEPTION_ASM_WRAPPER_DEVICE 252
EXCEPTION_ASM_WRAPPER_DEVICE 253
EXCEPTION_ASM_WRAPPER_DEVICE 254
EXCEPTION_ASM_WRAPPER_DEVICE 255
